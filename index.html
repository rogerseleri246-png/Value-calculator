<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Value Calculator</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="icon-192.png">
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
  }
</script>

<style>
  :root { --bg:#0f1115; --panel:#171a21; --ink:#e8eaf0; --muted:#aeb3c2; --accent:#6ee7a2; --danger:#ff6b6b; --ring:0 0 0 3px rgba(110,231,162,.25); }
  *{box-sizing:border-box}
  html,body{height:100%; overflow-x:hidden; -webkit-text-size-adjust:100%}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:radial-gradient(1200px 800px at 10% -20%,#1b2130 0%,var(--bg) 60%) fixed;
    color:var(--ink); display:grid; place-items:start center;
    padding:32px 16px; padding-bottom:calc(80px + env(safe-area-inset-bottom)); min-height:100vh;
  }
  .app{width:min(100%,980px); max-width:100vw; background:var(--panel); border-radius:14px; box-shadow:0 10px 40px rgba(0,0,0,.4); overflow:hidden}
  header,footer{padding:18px 22px; border-bottom:1px solid #242938}
  footer{border-top:1px solid #242938; border-bottom:none; color:var(--muted); font-size:12px}
  h1{margin:0; font-size:18px; letter-spacing:.2px}
  .grid{display:grid; gap:16px; padding:20px; padding-bottom:20px}
  .panel{background:#12151c; border:1px solid #242938; border-radius:12px; padding:16px; max-width:100%}
  .panel h2{margin:0 0 10px; font-size:15px; color:var(--muted); font-weight:600}
  .row{display:grid; gap:12px; grid-template-columns:1fr 1fr 1fr 1fr}
  .row.compact{grid-template-columns:1fr 1fr 1fr}
  .field{display:grid; gap:6px; min-width:0}
  .field label{font-size:12px; color:var(--muted); white-space:normal; word-break:normal}
  input,select{
    width:100%; padding:10px 12px; background:#0f1218; border:1px solid #2a3042; border-radius:10px; color:var(--ink); outline:none; transition:box-shadow .15s ease,border-color .15s ease; font-size:16px
  }
  input:focus,select:focus{border-color:var(--accent); box-shadow:var(--ring)}
  input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none; margin:0}
  .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; background:#10141b; border:1px solid #2a3042; color:var(--ink); cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  .btn.accent{background:linear-gradient(135deg,#2b7a5b,#1f5a43); border-color:#2b7a5b}
  .btn.danger{border-color:#4f1c1c; color:#ffbcbc}
  .stack{display:flex; flex-wrap:wrap; gap:10px}
  .earner{border:1px dashed #2a3042; border-radius:12px; padding:12px; margin-top:8px}
  .split{display:grid; grid-template-columns:1fr auto; align-items:start; gap:10px}
  .right{text-align:right}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .summary{display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-top:6px}
  .card{background:#0e1117; border:1px solid #242938; border-radius:12px; padding:14px; max-width:100%}
  .big{font-size:24px; font-weight:700}
  .muted{color:var(--muted); font-size:12px}
  .toggle{display:flex; align-items:flex-start; gap:10px}
  .toggle input{margin-top:2px}
  .toggle span{display:block; max-width:calc(100% - 40px); white-space:normal; overflow-wrap:break-word; word-break:normal; hyphens:auto; line-height:1.3}
  .hr{height:1px; background:#242938; margin:10px 0}
  @media (max-width:900px){.row,.row.compact,.summary{grid-template-columns:1fr 1fr}}
  @media (max-width:560px){.row,.row.compact,.summary{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="app" id="app">
    <header><h1>Value Calculator <span style="font-weight:400;color:#aeb3c2">v7</span></h1></header>

    <div class="grid">
      <!-- Earners -->
      <section class="panel" id="earnersPanel">
        <div class="split">
          <h2>Household earners</h2>
          <button class="btn" id="addEarnerBtn" type="button">+ Add earner</button>
        </div>
        <div id="earners"></div>
      </section>

      <!-- Disposable toggle -->
      <section class="panel">
        <h2>Disposable option</h2>
        <label class="toggle">
          <input id="useDisposable" type="checkbox" />
          <span>Use disposable income (after fixed monthly costs)</span>
        </label>
        <div class="row compact" id="disposableRow" style="margin-top:10px; display:none;">
          <div class="field">
            <label for="monthlyFixed">Fixed monthly costs (£)</label>
            <input id="monthlyFixed" type="number" min="0" step="0.01" placeholder="e.g. 2200" />
          </div>
          <div class="field">
            <label for="extraSavingsRate">Savings skim (% of income)</label>
            <input id="extraSavingsRate" type="number" min="0" max="100" step="0.1" value="0" />
          </div>
          <div class="field">
            <label for="weeksPerYear">Working weeks per year</label>
            <input id="weeksPerYear" type="number" min="1" max="52" step="1" value="46" />
          </div>
        </div>
      </section>

      <!-- Purchase -->
      <section class="panel">
        <h2>Purchase</h2>
        <div class="row compact">
          <div class="field">
            <label for="price">Price (£)</label>
            <input id="price" type="number" min="0" step="0.01" placeholder="e.g. 799.99" />
          </div>
          <div class="field">
            <label for="priceExtras">Fees, delivery, add-ons (£)</label>
            <input id="priceExtras" type="number" min="0" step="0.01" value="0" />
          </div>
          <div class="field">
            <label for="taxToggle">Include VAT?</label>
            <select id="taxToggle">
              <option value="inc">Price already includes VAT</option>
              <option value="add">Add 20% VAT</option>
              <option value="none">No VAT</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Results -->
      <section class="panel" id="resultsPanel">
        <h2>Result</h2>
        <div class="summary">
          <div class="card">
            <div class="muted">Household net hourly rate</div>
            <div class="big mono" id="netHourly">£0.00</div>
            <div class="muted" id="rateNote">Based on inputs</div>
          </div>
          <div class="card">
            <div class="muted">Effective hourly (disposable mode)</div>
            <div class="big mono" id="dispHourly">£0.00</div>
            <div class="muted">After fixed costs and savings skim</div>
          </div>
          <div class="card">
            <div class="muted">Total price considered</div>
            <div class="big mono" id="totalPrice">£0.00</div>
            <div class="muted" id="vatNote">VAT handling</div>
          </div>
          <div class="card">
            <div class="muted">Time needed</div>
            <div class="big mono" id="hoursNeeded">0.0 h</div>
            <div class="muted" id="modeNote">Standard or disposable</div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="stack">
          <button class="btn accent" id="calcBtn" type="button">Calculate</button>
          <button class="btn" id="toggleModeBtn" type="button">Toggle standard / disposable</button>
          <button class="btn" id="saveBtn" type="button">Save inputs</button>
          <button class="btn danger" id="resetBtn" type="button">Reset</button>
        </div>
      </section>
    </div>

    <footer>UK PAYE simplified. Personal Allowance £12,570; basic 20%, higher 40%, additional 45%; NI 8% to £50,270 then 2%.</footer>
  </div>

<script>
/* Utils */
const $ = (s, c=document) => c.querySelector(s);
const $$ = (s, c=document) => Array.from(c.querySelectorAll(s));
const money = v => isFinite(v) ? '£' + (Math.round(v * 100) / 100).toFixed(2) : '£0.00';
const debounce = (fn, ms) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms);} };

/* Friendly duration:
   < 12h -> "H h"
   12h..7d -> "D d H h"
   >= 7d -> "W w D d"  */
function fmtTime(hours) {
  if (!isFinite(hours) || hours === Infinity || hours <= 0) return '—';
  if (hours < 12) return `${(Math.round(hours*10)/10).toFixed(1)} h`;

  const days = Math.floor(hours / 24);
  const remH = Math.round(hours - days*24);
  if (days < 7) return `${days} d${remH ? ` ${remH} h` : ''}`;

  const weeks = Math.floor(days / 7);
  const remD = days % 7;
  return `${weeks} w${remD ? ` ${remD} d` : ''}`;
}

/* UK PAYE simplified */
function ukNetFromGross({gross, pensionPct=0, salarySacrifice=true, personalAllowance=12570}) {
  gross = Math.max(0, +gross || 0);
  const p = Math.max(0, Math.min(100, +pensionPct||0)) / 100;

  const pensionAmt = gross * p;
  const grossForTax = gross - pensionAmt;
  const grossForNI  = salarySacrifice ? (gross - pensionAmt) : gross;

  let pa = personalAllowance;
  const taperExcess = Math.max(0, grossForTax - 100000);
  pa = Math.max(0, pa - Math.floor(taperExcess / 2));

  const taxable = Math.max(0, grossForTax - pa);
  const basicBand = 37700, higherCap = 125140;
  const atBasic  = Math.min(taxable, basicBand);
  const atHigher = Math.min(Math.max(taxable - basicBand, 0), Math.max(higherCap - basicBand, 0));
  const atAddl   = Math.max(taxable - higherCap, 0);
  const tax = atBasic*0.20 + atHigher*0.40 + atAddl*0.45;

  const niPT=12570, niUEL=50270;
  const niEarn = Math.max(0, grossForNI - niPT);
  const niBasic = Math.min(Math.max(0, niUEL - niPT), niEarn) * 0.08;
  const niHigh  = Math.max(0, niEarn - (niUEL - niPT)) * 0.02;
  const ni = niBasic + niHigh;

  const net = gross - pensionAmt - tax - ni;
  return { net };
}

/* Earners UI */
const earnersDiv = $('#earners');
let earnerId = 0;
function earnerTemplate(id) {
  return `
  <div class="earner" data-id="${id}">
    <div class="row">
      <div class="field"><label>Name (optional)</label><input type="text" class="name" placeholder="e.g. Elle" /></div>
      <div class="field">
        <label>Income type</label>
        <select class="incomeType">
          <option value="annual_net">Annual take-home (£/year)</option>
          <option value="monthly_net">Monthly take-home (£/month)</option>
          <option value="hourly_net">Hourly take-home (£/hour)</option>
          <option value="annual_gross_uk">Annual gross (UK PAYE)</option>
        </select>
      </div>
      <div class="field"><label>Amount</label><input type="number" min="0" step="0.01" class="amount" placeholder="e.g. 36000" /></div>
      <div class="field ukOnly"><label>Pension contribution (%)</label><input type="number" min="0" max="100" step="0.1" class="pensionPct" value="5" /></div>
    </div>
    <div class="row compact" style="margin-top:10px;">
      <div class="field"><label>Hours per week</label><input type="number" min="0" step="0.1" class="hoursPerWeek" value="37.5" /></div>
      <div class="field"><label>Weeks per year</label><input type="number" min="1" max="52" step="1" class="weeksPerYear" value="46" /></div>
      <div class="field nonUkOnly"><label>Other deductions (£/month)</label><input type="number" min="0" step="0.01" class="otherDeduct" value="0" /></div>
      <div class="field ukOnly"><label>Salary sacrifice pension?</label>
        <select class="salarySacrifice"><option value="yes" selected>Yes</option><option value="no">No</option></select>
      </div>
      <div class="field right"><label>&nbsp;</label><button class="btn danger removeBtn" type="button">Remove</button></div>
    </div>
  </div>`;
}
function addEarner(prefill) {
  const id = earnerId++;
  const wrap = document.createElement('div'); wrap.innerHTML = earnerTemplate(id);
  const card = wrap.firstElementChild; earnersDiv.appendChild(card);

  const incomeTypeSel = card.querySelector('.incomeType');
  const pensionField = card.querySelector('.pensionPct').closest('.field');
  const salarySacField = card.querySelector('.salarySacrifice').closest('.field');
  const otherDeductField = card.querySelector('.otherDeduct').closest('.field');

  function toggles() {
    const uk = incomeTypeSel.value === 'annual_gross_uk';
    pensionField.style.display = uk ? 'grid' : 'none';
    salarySacField.style.display = uk ? 'grid' : 'none';
    otherDeductField.style.display = uk ? 'none' : 'grid';
  }
  incomeTypeSel.addEventListener('change', toggles); toggles();

  if (prefill) for (const [cls, val] of Object.entries(prefill)) {
    const node = card.querySelector('.' + cls); if (node) node.value = val;
  }
  card.querySelector('.removeBtn').addEventListener('click', () => { card.remove(); calculate(); });
  Array.from(card.querySelectorAll('.field input, .field select')).forEach(n => n.addEventListener('input', debounce(calculate, 120)));
}

/* Disposable toggle */
const useDisposable = $('#useDisposable');
const disposableRow = $('#disposableRow');
useDisposable.addEventListener('change', () => { disposableRow.style.display = useDisposable.checked ? 'grid' : 'none'; calculate(); });

/* Purchase listeners */
['#price','#priceExtras','#taxToggle','#monthlyFixed','#extraSavingsRate','#weeksPerYear']
  .forEach(sel => $(sel).addEventListener('input', debounce(calculate,120)));

/* Buttons */
document.getElementById('addEarnerBtn').addEventListener('click', () => addEarner());
document.getElementById('calcBtn').addEventListener('click', calculate);
document.getElementById('toggleModeBtn').addEventListener('click', () => { useDisposable.checked = !useDisposable.checked; useDisposable.dispatchEvent(new Event('change')); });
document.getElementById('saveBtn').addEventListener('click', saveState);
document.getElementById('resetBtn').addEventListener('click', () => { localStorage.removeItem('hta_state'); location.reload(); });

/* Maths */
function collectEarners() {
  return $$('.earner').map(c => {
    const incomeType = c.querySelector('.incomeType').value;
    const amount = +c.querySelector('.amount').value || 0;
    const hpw = +c.querySelector('.hoursPerWeek').value || 0;
    const wpy = +c.querySelector('.weeksPerYear').value || 0;
    let annualNet = 0;

    if (incomeType === 'annual_net') {
      const other = +c.querySelector('.otherDeduct').value || 0;
      annualNet = Math.max(0, amount - (other * 12));
    } else if (incomeType === 'monthly_net') {
      const other = +c.querySelector('.otherDeduct').value || 0;
      annualNet = Math.max(0, (amount - other) * 12);
    } else if (incomeType === 'hourly_net') {
      annualNet = amount * (hpw * wpy);
    } else if (incomeType === 'annual_gross_uk') {
      const pensionPct = +c.querySelector('.pensionPct').value || 0;
      const salarySacrifice = (c.querySelector('.salarySacrifice').value === 'yes');
      const { net } = ukNetFromGross({ gross: amount, pensionPct, salarySacrifice });
      annualNet = net;
    }
    const annualHours = hpw * wpy;
    return { annualNet, annualHours };
  });
}
function householdRates() {
  const earners = collectEarners();
  const totalNet = earners.reduce((a, e) => a + e.annualNet, 0);
  const totalHours = earners.reduce((a, e) => a + e.annualHours, 0);
  const netHourly = totalHours > 0 ? totalNet / totalHours : 0;

  const fixed = +$('#monthlyFixed').value || 0;
  const skim = (+$('#extraSavingsRate').value || 0) / 100;
  const weeksPerYear = +$('#weeksPerYear').value || 46;

  const weeklyHours = earners.reduce((a, e) => a + e.annualHours, 0) / 52;
  const annualAfterFixed = Math.max(0, totalNet - (fixed * 12)) * (1 - skim);
  const dispHourly = (weeklyHours * weeksPerYear) > 0 ? annualAfterFixed / (weeklyHours * weeksPerYear) : 0;

  return { netHourly, dispHourly, totalNet, totalHours };
}
function totalPrice() {
  const base = +$('#price').value || 0;
  const extras = +$('#priceExtras').value || 0;
  const vatMode = $('#taxToggle').value;
  let total = base + extras;
  let vatNote = 'Included';
  if (vatMode === 'add') { total = total * 1.20; vatNote = '20% added'; }
  else if (vatMode === 'none') vatNote = 'Not applied';
  return { total, vatNote };
}
function calculate() {
  const { netHourly, dispHourly, totalNet, totalHours } = householdRates();
  const { total } = totalPrice();
  const hourly = $('#useDisposable').checked ? dispHourly : netHourly;
  const hoursNeeded = hourly > 0 ? total / hourly : Infinity;

  $('#netHourly').textContent = money(netHourly);
  $('#dispHourly').textContent = money(dispHourly);
  $('#totalPrice').textContent = money(total);
  $('#hoursNeeded').textContent = fmtTime(hoursNeeded);

  $('#modeNote').textContent = $('#useDisposable').checked ? 'Disposable mode.' : 'Standard mode.';
  $('#rateNote').textContent = totalHours > 0 ? `£${(totalNet/12).toFixed(0)}/mo across ${Math.round(totalHours)} h/yr` : 'Add earners and hours';
}

/* Save / Load */
function saveState() {
  const state = {
    useDisposable: $('#useDisposable').checked,
    monthlyFixed: $('#monthlyFixed').value,
    extraSavingsRate: $('#extraSavingsRate').value,
    weeksPerYear: $('#weeksPerYear').value,
    price: $('#price').value,
    priceExtras: $('#priceExtras').value,
    taxToggle: $('#taxToggle').value,
    earners: $$('.earner').map(card => ({
      name: card.querySelector('.name').value,
      incomeType: card.querySelector('.incomeType').value,
      amount: card.querySelector('.amount').value,
      pensionPct: (card.querySelector('.pensionPct')||{}).value,
      salarySacrifice: (card.querySelector('.salarySacrifice')||{}).value,
      hoursPerWeek: card.querySelector('.hoursPerWeek').value,
      weeksPerYear: card.querySelector('.weeksPerYear').value,
      otherDeduct: (card.querySelector('.otherDeduct')||{}).value
    }))
  };
  localStorage.setItem('hta_state', JSON.stringify(state)); calculate();
}
function loadState() {
  const raw = localStorage.getItem('hta_state');
  if (raw) {
    try {
      const s = JSON.parse(raw);
      $('#useDisposable').checked = !!s.useDisposable;
      $('#disposableRow').style.display = $('#useDisposable').checked ? 'grid' : 'none';
      $('#monthlyFixed').value = s.monthlyFixed ?? '';
      $('#extraSavingsRate').value = s.extraSavingsRate ?? '0';
      $('#weeksPerYear').value = s.weeksPerYear ?? '46';
      $('#price').value = s.price ?? '';
      $('#priceExtras').value = s.priceExtras ?? '0';
      $('#taxToggle').value = s.taxToggle ?? 'inc';
      if (Array.isArray(s.earners) && s.earners.length) {
        earnersDiv.innerHTML = '';
        s.earners.forEach(e => { addEarner(); const last=earnersDiv.lastElementChild;
          last.querySelector('.incomeType').value = e.incomeType ?? 'annual_net';
          (last.querySelector('.amount')||{}).value = e.amount ?? '';
          const p = last.querySelector('.pensionPct'); if (p) p.value = e.pensionPct ?? '5';
          const ss = last.querySelector('.salarySacrifice'); if (ss) ss.value = e.salarySacrifice ?? 'yes';
          (last.querySelector('.hoursPerWeek')||{}).value = e.hoursPerWeek ?? '37.5';
          (last.querySelector('.weeksPerYear')||{}).value = e.weeksPerYear ?? '46';
          const od = last.querySelector('.otherDeduct'); if (od) od.value = e.otherDeduct ?? '0';
          last.querySelector('.incomeType').dispatchEvent(new Event('change'));
        });
      }
    } catch {}
  } else { addEarner(); }
  if (!document.querySelector('.earner')) addEarner();
  calculate();
}
window.addEventListener('load', loadState);
</script>
</body>
</html>